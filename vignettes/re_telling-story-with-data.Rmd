---
title: 'RE: Telling a story from data'
output: html_document
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {rmarkdown::render(input, output_dir = "../html")})
---

# Setup and first thoughts
At first, let's load the necessary libraries and take a look at the data. From the documentation we see that it is about New York air quality measurements from May to September 1973 (measured daily).
The different variables were **measured at different places around New York**, for example `Ozone` at Roosevelt Island, `Solar.R` at Central Park.
For us, it is not so convenient to work with 'mph' and 'degrees F', so we convert it to 'kmph' and 'degrees C'. For this conversion we use the package {weathermetrics}.


```{r message=FALSE}
library(weathermetrics)
library(tidyverse)
airquality |> str()
airquality |> summary()
airquality |> head()
```

We immediately see some other problems: At least two columns contain `NA` values and we don't have a very large data set (153 observations).
Let us take a further look at the missing values using the `visdat::vis_miss()` function.

```{r}
visdat::vis_miss(
  airquality,
  cluster = FALSE, 
  warn_large_data = FALSE
  )
```

Unfortunately, 24% of the rows have no `Ozone` value and 5% have no `Solar.R` value.
We also see that most of the missing values are between row 25 and row 70.
This decreases robustness of the analysis, especially for the month June and early July.

We convert the units and set the `Month`, `Day` as factors. Note that this unit conversion creates some floating point imprecision.

```{r}
airquality <- airquality |> 
  mutate(
    Date = lubridate::ymd(paste(1973, Month, Day, sep = "-")),
    across(c(Month, Day), as.factor),
    Wind_kmh = weathermetrics::convert_wind_speed(Wind, "mph", "kmph"),
    Temp_C = weathermetrics::convert_temperature(Temp, "f", "c"))
str(airquality)
```

# Telling a story

## Hypotheses
- The higher the temperature and solar radiation, the higher the Ozone concentration.
- The higher the Wind speed, the lower the Ozone concentration.
Why? 
A higher temperature is caused by the incoming sunlight, thus a higher temperature should increase the ozone concentration.
For the same reason an increase in solar radiation should lead to an increase in ozone concentration.

In contrast, more wind should lead to a decrease in ozone concentration because generally in a city we expect a higher ozone concentration than in more green area / ocean. So with more wind, more ozone will be outgoing than incoming.

## Testing hypothesis
We are now interested in showing the relation between `Ozone` and the other covariates.
We plot the distribution of ozone measurements within each month.

```{r}
plot <- ggplot(
  data = airquality,
  aes(x = Month, y = Ozone)) +
  geom_boxplot(fill = "grey70", na.rm = TRUE) + # Remove the NA values
  labs(title = "Ozone by month",
       x = "Month",
       y = "Ozone (ppb)")
plot
```

We see that ozone peaks in the summer months July and August. It seems reasonable that this is due to more sunlight and also higher temperature.

```{r}
plot <- ggplot(
  data = airquality,
  aes(x = Month, y = Temp_C)) +
  geom_boxplot(fill = "grey70", na.rm = TRUE) +
  labs(title = "Maximum daily temperature by month",
       x = "Month",
       y = "Maximum daily temperature (°C)")
plot
```

As expected, the temperatures by month boxplot looks very similar to the ozone by month boxplot.

Let us analyze two linear models with just one predictor for `Ozone`.

```{r}
plot_temp <- ggplot(
  airquality,
  aes(Temp_C, Ozone),
) +
  geom_point(na.rm = TRUE) +
  geom_smooth(formula = y ~ x, method = "lm", color = "red", se = F, na.rm = TRUE) +
  labs(x = "Maximum daily temperature (°C)",
       y = "Ozone (ppb)",
       title = "Linear model temperature")

plot_wind <- ggplot(
  airquality,
  aes(Wind_kmh, Ozone),
) +
  geom_point(na.rm = TRUE) +
  geom_smooth(formula = y ~ x, method = "lm", color = "red", se = F, na.rm = TRUE) +
  labs(x = "Wind speed (km/h)",
       y = "Ozone (ppb)",
       title = "Linear model wind speed"
       )

cowplot::plot_grid(plot_temp, plot_wind, nrow = 2)
```

We see that the linear models show a slope that we expected (positive for temperature and negative for wind speed). However, the model is too simple and does not capture the full relationship. With variable transformation, it could probably be improved but we did not cover it really until now, so let us keep the linear model but use multiple predictors.

```{r}
x <- c("Temp_C", "Solar.R", "Wind_kmh")
y <- "Ozone"

lin_mod <- lm(
  reformulate(x, y),
  data = airquality,
  na.action = na.omit,
)

lin_mod |> summary()
```

**Comment**
The coefficients have the sign that we expected and the p-value is also very small. So it is very unlikely that the variables have no true impact on `Ozone`.

The $R^2$ tells us that approximately 60 \% of the variability in `Ozone` can be explained by `Wind_kmh`, `Temp_C` and `Solar.R`.


## Conclusion
The data confirmed our initial hypotheses that a higher temperature and solar radiation level generally increase the ozone concentration in New York. On the other hand, a higher wind speed decreases the ozone concentration in the city. However, it was difficult to get some robust results / models for `Ozone` because we are given so little data $\approx 150$ rows and many rows contain `NA` values. Also the data was measured 50 years ago and only in a single year (1973) which is not ideal.
